<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LabFlow 2026 - SENAI CIMATEC</title>
    
    <!-- React e ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- BIBLIOTECAS PARA PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.5); }
        
        .font-logo { font-family: 'Arial Black', 'Arial', sans-serif; }

        @keyframes pulse-alert {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .animate-blink { animation: pulse-alert 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

        /* --- TEMA CARNAVAL (Sazonal) --- */
        .theme-carnaval .header-bg {
            background: linear-gradient(135deg, #ffffff 0%, #fdf2f8 50%, #fff7ed 100%);
            border-bottom: 1px solid #fbcfe8;
        }
        .theme-carnaval .btn-primary {
            background-color: #be185d;
        }
        .theme-carnaval .btn-primary:hover {
            background-color: #9d174d;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy, setDoc, getDoc, where, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIGURA√á√ÉO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyAhJylWo5-RAyxsCFV3w9ounadvauJ_v_8",
            authDomain: "labflow-2026.firebaseapp.com",
            projectId: "labflow-2026",
            storageBucket: "labflow-2026.firebasestorage.app",
            messagingSenderId: "564680738234",
            appId: "1:564680738234:web:e6e1192ff9112305870983",
            measurementId: "G-0CBN5BRWY3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- CONSTANTES ---
        const SETORES = ['QGI', 'ESP', 'FQA', 'FRASCARIA', 'CRO', 'MIC', 'RECEP√á√ÉO', 'AUXILIARES', 'OUTROS']; 
        const SENHA_LOGISTICA = "cimatec2026";
        const SENHA_ADMIN = "adm2026";
        const SENHA_MASTER = "master2026"; 

        const CAT_GROUPS = {
            logistics: ['reagente', 'materiais', 'consumivel_log', 'consumivel'], 
            admin: ['epi', 'escritorio', 'consumivel_adm']
        };

        // Labels com √çcones para a Interface Web
        const CAT_LABELS = {
            'reagente': 'üß™ Reagente',
            'materiais': 'üì¶ Materiais',
            'consumivel_log': 'üß¥ Consum√≠vel (Lab)',
            'consumivel': 'üßª Consum√≠vel (Antigo)',
            'epi': 'ü•Ω EPI',
            'escritorio': 'üìé Escrit√≥rio',
            'consumivel_adm': 'üóëÔ∏è Consum√≠vel (Adm)'
        };

        // Labels Limpos para PDF (Sem emojis)
        const CAT_LABELS_CLEAN = {
            'reagente': 'Reagente',
            'materiais': 'Materiais',
            'consumivel_log': 'Consumivel (Lab)',
            'consumivel': 'Consumivel (Antigo)',
            'epi': 'EPI',
            'escritorio': 'Escritorio',
            'consumivel_adm': 'Consumivel (Adm)'
        };

        const InstitutionalLogo = () => (
            <div className="flex flex-col select-none cursor-default items-start">
                <div className="relative font-logo italic text-xs tracking-wider leading-none ml-0.5 flex" style={{ transform: 'skewX(-10deg)' }}>
                    <span className="text-[#013C97]">SENAI</span>
                </div>
                <div className="relative leading-none font-logo italic text-3xl tracking-tighter flex" style={{ transform: 'skewX(-10deg)' }}>
                    <span className="text-[#013C97]">CIMATEC</span>
                </div>
            </div>
        );

        const Icons = {
            Beaker: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4.5 3h15"/><path d="M6 3v16a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V3"/><path d="M6 14h12"/></svg>,
            Truck: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 18h5"/><path d="M19 18h1"/><path d="M14 18h1"/><path d="M10 18h1"/><path d="M19 18a2 2 0 0 0 2-2v-3.46a2 2 0 0 0-.58-1.42l-2.83-2.83a2 2 0 0 0-1.42-.58H15V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2"/><circle cx="7" cy="18" r="2"/><circle cx="17" cy="18" r="2"/></svg>,
            Briefcase: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
            Building2: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></svg>,
            ClipboardList: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></svg>,
            CheckCircle2: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>,
            PackageX: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l2-1.14"/><path d="m7.5 4.27 9 5.15"/><polyline points="3.29 7 12 12 20.71 7"/><line x1="12" x2="12" y1="22" y2="12"/><path d="m17 13 5 5m-5 0 5-5"/></svg>,
            Clock: () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            User: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            AlertCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            LogOut: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            Search: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            Trash2: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Save: () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            FileText: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>,
            X: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>,
            Lock: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            Unlock: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
            History: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><path d="M12 7v5l4 2"/></svg>,
            RefreshCw: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>,
            Edit: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
            Scissors: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="6" cy="6" r="3"/><circle cx="6" cy="18" r="3"/><line x1="20" x2="8.12" y1="4" y2="15.88"/><line x1="14.47" x2="20" y1="14.48" y2="20"/><line x1="8.12" x2="12" y1="8.12" y2="12"/></svg>,
            Shield: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>,
            Box: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l2-1.14"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" x2="12" y1="22.08" y2="12"/></svg>,
            ArrowUpCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="m16 12-4-4-4 4"/><path d="M12 16V8"/></svg>,
            ArrowDownCircle: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="m8 12 4 4 4-4"/><path d="M12 8v8"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Archive: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="5" x="2" y="3" rx="1"/><path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"/><path d="M10 12h4"/></svg>,
            Activity: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
        };

        const getNextMonday = () => { const d = new Date(); d.setDate(d.getDate() + ((1 + 7 - d.getDay()) % 7)); return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }); };
        const getNextOfficeDay = () => { const d = new Date(); const day = d.getDay(); let add = 0; if (day < 3 && day >= 1) { add = 3 - day; } else { add = (1 + 7 - day) % 7; if(add === 0) add = 7; } d.setDate(d.getDate() + add); return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }); };
        const formatDate = (isoString) => { if (!isoString) return '-'; const date = new Date(isoString); return date.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }); };
        const isRecent = (dateString, days = 7) => { if (!dateString) return false; const date = new Date(dateString); const now = new Date(); const diffTime = Math.abs(now - date); return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) <= days; };
        
        const isCarnivalSeason = () => {
            const d = new Date();
            return d.getMonth() === 1;
        };

        const processStockTransaction = async (itemName, quantity, type, origin, user, requestId = null, notes = '') => {
            if (user.role === 'logistics' && origin === 'pedido') {
                console.log("Log√≠stica: Baixa direta sem controle de estoque f√≠sico.");
                return;
            }

            const q = query(collection(db, 'estoque_lab_2026'), where('name', '==', itemName));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                if (origin === 'pedido') throw new Error(`Item "${itemName}" n√£o encontrado no estoque. Cadastre-o primeiro.`);
                return;
            }

            const stockItem = querySnapshot.docs[0];
            const currentQty = parseInt(stockItem.data().currentQty || 0);
            const change = parseInt(quantity);

            if (type === 'out' && currentQty < change) {
                throw new Error(`Estoque insuficiente de "${itemName}". Atual: ${currentQty}, Necess√°rio: ${change}`);
            }

            const newQty = type === 'in' ? currentQty + change : currentQty - change;

            await updateDoc(doc(db, 'estoque_lab_2026', stockItem.id), {
                currentQty: newQty,
                updatedAt: new Date().toISOString()
            });

            await addDoc(collection(db, 'movimentacoes_estoque_2026'), {
                itemId: stockItem.id,
                itemName: itemName,
                type: type,
                quantity: change,
                origin: origin,
                requestId: requestId,
                user: user.name,
                userRole: user.role,
                timestamp: new Date().toISOString(),
                balanceAfter: newQty,
                notes: notes
            });
        };

        const LoginScreen = ({ onLogin }) => {
            const [name, setName] = React.useState('');
            const [role, setRole] = React.useState('lab_tech');
            const [sector, setSector] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [error, setError] = React.useState('');

            const handleEnter = () => {
                setError(''); if (!name.trim()) return setError("Digite seu nome.");
                if (role === 'logistics') { if (password !== SENHA_LOGISTICA) return setError("Senha incorreta."); onLogin({ name, role, sector: 'LOG√çSTICA' }); }
                else if (role === 'admin') { if (password !== SENHA_ADMIN) return setError("Senha incorreta."); onLogin({ name, role, sector: 'ADMINISTRA√á√ÉO' }); }
                else if (role === 'master') { if (password !== SENHA_MASTER) return setError("Senha incorreta."); onLogin({ name, role, sector: 'GESTOR DO SISTEMA' }); }
                else { if (!sector) return setError("Selecione seu setor."); onLogin({ name, role, sector }); }
            };

            return (
                <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full border border-slate-100 fade-in">
                        <div className="flex justify-center mb-8"><InstitutionalLogo /></div>
                        <h2 className="text-xl font-semibold text-center text-slate-700 mb-1">LabFlow 2026</h2>
                        <p className="text-center text-slate-500 mb-6 text-sm">Controle de Almoxarifado & Adm</p>
                        <div className="space-y-4">
                            <div><label className="block text-sm font-bold text-slate-700 mb-1">Seu Nome</label><input type="text" value={name} onChange={(e) => setName(e.target.value)} placeholder="Ex: Jo√£o Silva" className="w-full p-3 border border-slate-300 rounded-lg outline-none" /></div>
                            <div><label className="block text-sm font-bold text-slate-700 mb-1">Fun√ß√£o</label><div className="grid grid-cols-2 gap-2"><button onClick={() => setRole('lab_tech')} className={`p-2 rounded-lg border flex flex-col items-center justify-center gap-1 ${role === 'lab_tech' ? 'bg-blue-50 border-blue-500 text-blue-700' : 'border-slate-200 text-slate-500'}`}><Icons.Beaker /><span className="text-xs font-medium">Lab</span></button><button onClick={() => setRole('logistics')} className={`p-2 rounded-lg border flex flex-col items-center justify-center gap-1 ${role === 'logistics' ? 'bg-indigo-50 border-indigo-500 text-indigo-700' : 'border-slate-200 text-slate-500'}`}><Icons.Truck /><span className="text-xs font-medium">Log√≠stica</span></button><button onClick={() => setRole('admin')} className={`p-2 rounded-lg border flex flex-col items-center justify-center gap-1 ${role === 'admin' ? 'bg-purple-50 border-purple-500 text-purple-700' : 'border-slate-200 text-slate-500'}`}><Icons.Briefcase /><span className="text-xs font-medium">Admin</span></button><button onClick={() => setRole('master')} className={`p-2 rounded-lg border flex flex-col items-center justify-center gap-1 ${role === 'master' ? 'bg-red-50 border-red-500 text-red-700' : 'border-slate-200 text-slate-500'}`}><Icons.Shield /><span className="text-xs font-medium">Gestor</span></button></div></div>
                            {role === 'lab_tech' ? (<div className="fade-in"><label className="block text-sm font-bold text-slate-700 mb-1">Setor</label><div className="relative"><div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Building2 /></div><select value={sector} onChange={(e) => setSector(e.target.value)} className="w-full pl-10 pr-3 py-3 border border-slate-300 rounded-lg outline-none bg-white"><option value="" disabled>Selecione...</option>{SETORES.map(s => <option key={s} value={s}>{s}</option>)}</select></div></div>) : (<div className="fade-in"><label className="block text-sm font-bold text-slate-700 mb-1">Senha</label><div className="relative"><div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Lock /></div><input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="Senha" className="w-full pl-10 pr-3 py-3 border border-slate-300 rounded-lg outline-none" /></div></div>)}
                            {error && <div className="text-red-500 text-sm font-medium text-center bg-red-50 p-2 rounded">{error}</div>}
                            <button onClick={handleEnter} className="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow uppercase">Entrar</button>
                        </div>
                    </div>
                </div>
            );
        };

        const NoticeBanner = ({ notices, userRole, onUpdateNotice }) => {
            const [isEditing, setIsEditing] = React.useState(false);
            const [tempLogistics, setTempLogistics] = React.useState(notices.logistics || '');
            const [tempAdmin, setTempAdmin] = React.useState(notices.admin || '');
            React.useEffect(() => { setTempLogistics(notices.logistics || ''); setTempAdmin(notices.admin || ''); }, [notices]);
            const handleSave = () => { onUpdateNotice({ logistics: (userRole === 'logistics' || userRole === 'master') ? tempLogistics : notices.logistics, admin: (userRole === 'admin' || userRole === 'master') ? tempAdmin : notices.admin }); setIsEditing(false); };
            if (isEditing) return (<div className="bg-yellow-50 border-b border-yellow-200 p-4 animate-in fade-in"><h4 className="text-sm font-bold text-yellow-800 mb-2 flex items-center gap-2"><Icons.Edit/> Editar Aviso</h4><div className="flex flex-col gap-3">{(userRole === 'logistics' || userRole === 'master') && <input className="w-full p-2 border rounded text-sm outline-none" value={tempLogistics} onChange={e => setTempLogistics(e.target.value)} placeholder="Aviso Log√≠stica..." />}{(userRole === 'admin' || userRole === 'master') && <input className="w-full p-2 border rounded text-sm outline-none" value={tempAdmin} onChange={e => setTempAdmin(e.target.value)} placeholder="Aviso Administra√ß√£o..." />}<div className="flex gap-2 justify-end"><button onClick={() => setIsEditing(false)} className="px-3 py-1 text-xs text-slate-500 rounded border bg-white">Cancelar</button><button onClick={handleSave} className="bg-blue-600 text-white px-4 py-1 rounded text-xs font-bold shadow-sm">Salvar</button></div></div></div>);
            if (!notices.logistics && !notices.admin && userRole !== 'logistics' && userRole !== 'admin' && userRole !== 'master') return null;
            return (<div className="bg-gradient-to-r from-orange-50 via-yellow-50 to-orange-50 border-b border-orange-200 relative shadow-sm"><div className="max-w-5xl mx-auto px-4 py-2 flex flex-col sm:flex-row items-center justify-between gap-2 text-center sm:text-left min-h-[40px]"><div className="flex-1 flex flex-col sm:flex-row gap-x-6 gap-y-2 justify-center sm:justify-start items-center w-full">{notices.logistics && <div className="flex items-center gap-2 text-orange-800 animate-blink font-semibold text-sm"><span className="bg-orange-600 text-white text-[10px] px-1.5 py-0.5 rounded font-bold uppercase">Log√≠stica</span><span>{notices.logistics}</span></div>}{notices.admin && <div className="flex items-center gap-2 text-indigo-900 animate-blink font-semibold text-sm"><span className="bg-indigo-600 text-white text-[10px] px-1.5 py-0.5 rounded font-bold uppercase">Adm</span><span>{notices.admin}</span></div>}</div>{userRole !== 'lab_tech' && <button onClick={() => setIsEditing(true)} className="text-slate-400 hover:text-blue-600 p-1.5 bg-white/50 hover:bg-white rounded-full transition"><Icons.Edit /></button>}</div></div>);
        };

        const InventoryItemCard = ({ item, isLocked, onUpdateQty, onDelete, onEdit }) => {
            const [isEditing, setIsEditing] = React.useState(false);
            const [editData, setEditData] = React.useState({ ...item });
            const handleSave = () => { onEdit(item.id, editData); setIsEditing(false); };
            const handleCancel = () => { setEditData({ ...item }); setIsEditing(false); };
            const getStatusColor = (current, min) => { const cur = parseInt(current); const minimum = parseInt(min); if (cur <= 0 || cur < minimum) return 'bg-red-100 text-red-700 border-red-200'; if (cur >= minimum && cur <= minimum * 1.2) return 'bg-yellow-100 text-yellow-800 border-yellow-200'; return 'bg-green-100 text-green-700 border-green-200'; };
            const getStatusLabel = (current, min) => { const cur = parseInt(current); const minimum = parseInt(min); if (cur <= 0 || cur < minimum) return 'Cr√≠tico'; if (cur >= minimum && cur <= minimum * 1.2) return 'Aten√ß√£o'; return 'OK'; };

            if (isEditing) return (<div className="bg-white p-4 rounded-xl shadow-sm border border-blue-200 relative overflow-hidden"><div className="flex flex-col gap-2"><input className="p-1.5 border rounded text-sm font-bold" value={editData.name} onChange={e => setEditData({...editData, name: e.target.value})} placeholder="Nome" /><select className="p-1.5 border rounded text-xs" value={editData.category} onChange={e => setEditData({...editData, category: e.target.value})}><optgroup label="Log√≠stica"><option value="reagente">Reagente</option><option value="materiais">Materiais</option><option value="consumivel_log">Consum√≠vel Lab</option></optgroup><optgroup label="Adm"><option value="epi">EPI</option><option value="escritorio">Escrit√≥rio</option><option value="consumivel_adm">Consum√≠vel Adm</option></optgroup></select><input className="p-1.5 border rounded text-xs" value={editData.location} onChange={e => setEditData({...editData, location: e.target.value})} placeholder="Local" /><div className="grid grid-cols-3 gap-1"><input type="number" className="p-1.5 border rounded text-xs" value={editData.currentQty} onChange={e => setEditData({...editData, currentQty: e.target.value})} placeholder="Qtd" /><input type="number" className="p-1.5 border rounded text-xs" value={editData.minQty} onChange={e => setEditData({...editData, minQty: e.target.value})} placeholder="Min" /><select className="p-1.5 border rounded text-xs" value={editData.unit} onChange={e => setEditData({...editData, unit: e.target.value})}><option value="un">un</option><option value="cx">cx</option><option value="ml">ml</option><option value="L">L</option><option value="kg">kg</option><option value="pct">pct</option></select></div><div className="flex justify-end gap-2 mt-2"><button onClick={handleCancel} className="text-xs text-slate-500 hover:underline">Cancelar</button><button onClick={handleSave} className="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold">Salvar</button></div></div></div>);
            
            return (
                <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 relative overflow-hidden">
                    <div className={`absolute top-0 right-0 px-3 py-1 text-[10px] font-bold uppercase rounded-bl-lg border-l border-b ${getStatusColor(item.currentQty, item.minQty)}`}>{getStatusLabel(item.currentQty, item.minQty)}</div>
                    <div className="flex justify-between items-start mt-2"><div><h4 className="font-bold text-slate-800 text-lg leading-tight">{item.name}</h4><div className="text-xs text-slate-500 mb-2 mt-1">{CAT_LABELS[item.category] || item.category} ‚Ä¢ Local: {item.location || '-'}</div></div></div>
                    <div className="flex items-center justify-between mt-4 bg-slate-50 p-3 rounded-lg"><div className="text-center"><div className="text-xs text-slate-400 uppercase">M√≠n</div><div className="font-bold text-slate-600">{item.minQty}</div></div><div className="text-center"><div className="text-xs text-slate-400 uppercase">Atual</div><div className="text-2xl font-bold text-blue-600">{item.currentQty} <span className="text-sm text-slate-400 font-normal">{item.unit}</span></div></div><div className="flex flex-col gap-1"><button onClick={() => onUpdateQty(item.id, item.name, item.currentQty, 1)} className="p-1 bg-green-100 text-green-700 rounded hover:bg-green-200"><Icons.Plus/></button><button onClick={() => onUpdateQty(item.id, item.name, item.currentQty, -1)} className="p-1 bg-red-100 text-red-700 rounded hover:bg-red-200"><Icons.X/></button></div></div>
                    {!isLocked && (<div className="flex justify-between mt-3 pt-3 border-t border-slate-100 animate-in fade-in"><button onClick={() => onDelete(item.id)} className="text-red-500 hover:bg-red-50 p-1.5 rounded transition"><Icons.Trash2 /></button><button onClick={() => setIsEditing(true)} className="text-blue-500 hover:bg-blue-50 p-1.5 rounded transition"><Icons.Edit /></button></div>)}
                </div>
            );
        };

        const RequestCard = ({ req, role, onDelete, onUpdateStatus, onOutOfStock, onSaveStockInfo, onApprovePartial, onUpdateReq, currentUser }) => {
            const [itemCode, setItemCode] = React.useState(req.itemCode || '');
            const [storageLocation, setStorageLocation] = React.useState(req.storageLocation || '');
            const [hasChanges, setHasChanges] = React.useState(false);
            const [showPartialInput, setShowPartialInput] = React.useState(false);
            const [partialQty, setPartialQty] = React.useState(req.quantity);
            const [isEditingReq, setIsEditingReq] = React.useState(false);
            const [editItem, setEditItem] = React.useState(req.item);
            const [editQty, setEditQty] = React.useState(req.quantity);
            const [editUnit, setEditUnit] = React.useState(req.unit);
            const [editCategory, setEditCategory] = React.useState(req.category);
            const [editSector, setEditSector] = React.useState(req.requesterSector || '');

            React.useEffect(() => { if (!req.itemCode && !req.storageLocation && role !== 'lab_tech') { try { const catalog = JSON.parse(localStorage.getItem('labflow_catalog') || '{}'); const savedItem = catalog[req.item.trim().toLowerCase()]; if (savedItem) { if (savedItem.code) { setItemCode(savedItem.code); setHasChanges(true); } if (savedItem.loc) { setStorageLocation(savedItem.loc); setHasChanges(true); } } } catch (e) {} } }, [req.item, role]);

            const handleSaveInfo = () => { onSaveStockInfo(req.id, itemCode, storageLocation, req.item); setHasChanges(false); };
            const handleStatusAction = async (status) => { if (status === 'approved') { try { await processStockTransaction(req.item, req.quantity, 'out', 'pedido', currentUser, req.id, `Pedido Aprovado Total (${req.quantity} ${req.unit})`); onSaveStockInfo(req.id, itemCode, storageLocation, req.item); onUpdateStatus(req.id, status); } catch (error) { alert("Erro de Estoque: " + error.message); } } else { onUpdateStatus(req.id, status); } };
            const handlePartialConfirm = async () => { try { await processStockTransaction(req.item, partialQty, 'out', 'pedido', currentUser, req.id, `Pedido Aprovado Parcial (${partialQty}/${req.quantity} ${req.unit})`); onSaveStockInfo(req.id, itemCode, storageLocation, req.item); onApprovePartial(req.id, partialQty, req.quantity); setShowPartialInput(false); } catch (error) { alert("Erro de Estoque: " + error.message); } };
            const handleSaveEditReq = () => { onUpdateReq(req.id, { item: editItem, quantity: editQty, unit: editUnit, category: editCategory, requesterSector: editSector }); setIsEditingReq(false); };
            
            const isAdmCategory = CAT_GROUPS.admin.includes(req.category);
            const badgeColor = isAdmCategory ? 'bg-purple-100 text-purple-700 border-purple-200' : 'bg-slate-100 text-slate-700 border-slate-200';

            return (
                <div className={`bg-white rounded-lg shadow-sm border p-4 transition-all ${req.status === 'pending' ? 'border-l-4 border-l-yellow-400' : req.status === 'approved' ? 'border-l-4 border-l-green-500 bg-green-50/10' : 'border-l-4 border-l-red-500 opacity-75'}`}>
                    {isEditingReq ? (
                        <div className="flex flex-col gap-3 bg-blue-50/50 p-2 rounded"><h4 className="text-xs font-bold text-blue-800 uppercase">Editando Pedido (Gestor)</h4><div className="grid grid-cols-2 gap-2"><div className="col-span-2"><label className="text-[10px] font-bold text-blue-800 uppercase">Item</label><input className="p-2 border rounded text-sm w-full" value={editItem} onChange={e => setEditItem(e.target.value)} /></div><div><label className="text-[10px] font-bold text-blue-800 uppercase">Categoria</label><select className="p-2 border rounded text-sm w-full" value={editCategory} onChange={e => setEditCategory(e.target.value)}><optgroup label="Log√≠stica"><option value="reagente">üß™ Reagente</option><option value="materiais">üì¶ Materiais</option><option value="consumivel_log">üß¥ Consum√≠vel (Lab)</option></optgroup><optgroup label="Adm"><option value="epi">ü•Ω EPI</option><option value="escritorio">üìé Escrit√≥rio</option><option value="consumivel_adm">üóëÔ∏è Consum√≠vel (Adm)</option></optgroup></select></div><div className="flex gap-1"><div className="flex-1"><label className="text-[10px] font-bold text-blue-800 uppercase">Qtd</label><input className="p-2 border rounded text-sm w-full" type="number" value={editQty} onChange={e => setEditQty(e.target.value)} /></div><div className="w-20"><label className="text-[10px] font-bold text-blue-800 uppercase">Un</label><select className="p-2 border rounded text-sm w-full" value={editUnit} onChange={e => setEditUnit(e.target.value)}><option value="un">un</option><option value="cx">cx</option><option value="ml">ml</option><option value="L">L</option><option value="pct">pct</option></select></div></div><div className="col-span-2"><label className="text-[10px] font-bold text-blue-800 uppercase">Setor Solicitante</label><select className="p-2 border rounded text-sm w-full" value={editSector} onChange={e => setEditSector(e.target.value)}>{SETORES.map(s => <option key={s} value={s}>{s}</option>)}</select></div></div><div className="flex justify-end gap-2"><button onClick={() => setIsEditingReq(false)} className="px-3 py-1 bg-white border rounded text-xs">Cancelar</button><button onClick={handleSaveEditReq} className="px-3 py-1 bg-blue-600 text-white rounded text-xs font-bold">Salvar Altera√ß√µes</button></div></div>
                    ) : (
                        <div className="flex flex-col md:flex-row justify-between gap-4">
                            <div className="flex-1">
                                <div className="flex items-center flex-wrap gap-2 mb-2"><span className={`text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded border ${badgeColor}`}>{CAT_LABELS[req.category] || req.category}</span>{req.isUrgent && <span className="flex items-center gap-1 text-[10px] font-bold bg-red-100 text-red-600 px-2 py-0.5 rounded border border-red-200"><Icons.AlertCircle /> URGENTE</span>}<span className="text-xs text-slate-400 flex items-center gap-1 ml-auto md:ml-0"><Icons.Clock /> {formatDate(req.createdAt)}</span></div>
                                <div className="flex items-center gap-2"><div><h3 className="text-lg font-bold text-slate-800 leading-tight">{req.item}</h3><div className="text-sm font-medium text-slate-500 mt-1">Qtd: {req.quantity} {req.unit}</div></div>{role === 'master' && <button onClick={() => setIsEditingReq(true)} className="text-slate-300 hover:text-blue-500 p-1"><Icons.Edit /></button>}</div>
                                {role !== 'lab_tech' && (<div className="mt-3 flex gap-2 items-end"><div className="flex-1 max-w-[120px]"><label className="text-[10px] font-bold text-slate-400 uppercase">C√≥d.</label><input type="text" value={itemCode} onChange={(e) => { setItemCode(e.target.value); setHasChanges(true); }} placeholder="0000" className="w-full text-xs p-1.5 border border-slate-300 rounded outline-none"/></div><div className="flex-1 max-w-[120px]"><label className="text-[10px] font-bold text-slate-400 uppercase">Local</label><input type="text" value={storageLocation} onChange={(e) => { setStorageLocation(e.target.value); setHasChanges(true); }} placeholder="A1" className="w-full text-xs p-1.5 border border-slate-300 rounded outline-none"/></div>{hasChanges && <button onClick={handleSaveInfo} title="Salvar" className="mb-[1px] p-1.5 bg-blue-100 text-blue-600 rounded"><Icons.Save /></button>}</div>)}
                                {role === 'lab_tech' && (req.itemCode || req.storageLocation) && (<div className="mt-2 text-xs text-slate-500 flex gap-3">{req.itemCode && <span><strong>C√≥d:</strong> {req.itemCode}</span>}{req.storageLocation && <span><strong>Local:</strong> {req.storageLocation}</span>}</div>)}
                                <div className="mt-3 pt-3 border-t border-slate-50 flex flex-wrap items-center gap-3 text-sm text-slate-600"><div className="flex items-center gap-1.5 bg-slate-100 px-2 py-1 rounded"><Icons.User /> <span className="font-semibold">{req.requesterName}</span><span className="text-slate-300">|</span><span className="text-blue-600 font-bold text-xs">{req.requesterSector || 'N/A'}</span></div>{req.notes && <span className="italic text-slate-400 text-xs">Obs: {req.notes}</span>}</div>
                                {req.status === 'out_of_stock' && req.logisticsMessage && <div className="mt-2 bg-red-50 border border-red-100 p-2 rounded text-red-700 text-sm"><strong>Motivo:</strong> {req.logisticsMessage}</div>}
                                {req.status === 'approved' && req.logisticsMessage && <div className="mt-2 bg-yellow-50 border border-yellow-100 p-2 rounded text-yellow-800 text-sm"><strong>Nota:</strong> {req.logisticsMessage}</div>}
                            </div>
                            {role !== 'lab_tech' && (
                                <div className="flex flex-row md:flex-col gap-2 justify-center border-t md:border-t-0 md:border-l border-slate-100 pt-3 md:pt-0 md:pl-4 min-w-[140px]">
                                    {req.status === 'pending' ? (
                                        !showPartialInput ? (
                                            <>
                                                <button onClick={() => handleStatusAction('approved')} className="bg-green-100 text-green-700 py-1.5 px-3 rounded text-xs font-bold hover:bg-green-200 flex items-center justify-center gap-2" title="Entregar Total"><Icons.CheckCircle2 /> TOTAL</button>
                                                <button onClick={() => setShowPartialInput(true)} className="bg-orange-100 text-orange-700 py-1.5 px-3 rounded text-xs font-bold hover:bg-orange-200 flex items-center justify-center gap-2" title="Entregar Parcial"><Icons.Scissors /> PARCIAL</button>
                                                <button onClick={() => onOutOfStock(req.id)} className="bg-red-100 text-red-700 py-1.5 px-3 rounded text-xs font-bold hover:bg-red-200 flex items-center justify-center gap-2"><Icons.PackageX /> EM FALTA</button>
                                            </>
                                        ) : (
                                            <div className="flex flex-col gap-2 animate-in fade-in">
                                                <div className="text-xs font-bold text-slate-500 text-center">Qtd Real?</div>
                                                <input type="number" value={partialQty} onChange={(e) => setPartialQty(e.target.value)} className="w-full p-1 border rounded text-center text-sm font-bold"/>
                                                <div className="flex gap-1"><button onClick={() => setShowPartialInput(false)} className="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded py-1 text-xs">X</button><button onClick={handlePartialConfirm} className="flex-1 bg-green-600 hover:bg-green-700 text-white rounded py-1 text-xs font-bold">OK</button></div>
                                            </div>
                                        )
                                    ) : (
                                        <div className="text-center"><span className={`text-sm font-bold ${req.status === 'approved' ? 'text-green-600' : 'text-red-600'}`}>{req.status === 'approved' ? 'SEPARADO' : 'INDISPON√çVEL'}</span><button onClick={() => handleStatusAction('pending')} className="block mx-auto text-xs text-slate-400 underline mt-1">Alterar</button></div>
                                    )}
                                </div>
                            )}
                            {(role === 'lab_tech' || role === 'master') && req.status === 'pending' && role !== 'logistics' && role !== 'admin' && (<div className="flex items-center justify-end md:justify-center min-w-[50px] border-t md:border-t-0 md:border-l border-slate-100 pt-2 md:pl-4"><button onClick={() => onDelete(req.id)} className="ml-2 text-slate-300 hover:text-red-500"><Icons.Trash2 /></button></div>)}
                            {role === 'lab_tech' && req.status !== 'pending' && (<div className="flex items-center justify-end md:justify-center min-w-[100px] border-t md:border-t-0 md:border-l border-slate-100 pt-2 md:pl-4">{req.status === 'approved' && <div className="text-center"><span className="text-green-600 text-xs font-bold bg-green-50 px-2 py-1 rounded">DISPON√çVEL</span><div className="text-[10px] text-slate-400 mt-1">Retirar na 2¬™</div></div>}{req.status === 'out_of_stock' && <span className="text-red-600 text-xs font-bold bg-red-50 px-2 py-1 rounded">EM FALTA</span>}</div>)}
                        </div>
                    )}
                </div>
            );
        };

        const HistoryRow = ({ req, onMarkRestocked }) => (
            <div className="bg-white p-3 rounded-lg border border-slate-200 flex flex-col md:flex-row gap-4 items-center text-sm">
                <div className="flex-1 w-full">
                    <div className="flex justify-between mb-1"><span className="font-bold text-slate-700">{req.item}</span><span className="text-slate-400 text-xs">{formatDate(req.createdAt)}</span></div>
                    <div className="flex gap-2 text-xs text-slate-500"><span>{req.quantity} {req.unit}</span><span>‚Ä¢ {req.requesterName} ({req.requesterSector})</span>{req.itemCode && <span>‚Ä¢ C√≥d: {req.itemCode}</span>}</div>
                    <div className="mt-1"><span className="text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded border bg-slate-50 text-slate-500">{CAT_LABELS[req.category] || req.category}</span></div>
                    {req.logisticsMessage && <div className={`text-xs mt-1 ${req.status === 'approved' ? 'text-yellow-700 bg-yellow-50 p-1 rounded inline-block' : 'text-red-500'}`}>Obs: {req.logisticsMessage}</div>}
                </div>
                <div className="flex items-center gap-4 w-full md:w-auto justify-between md:justify-end">
                    <span className={`px-2 py-1 rounded text-xs font-bold ${req.status === 'approved' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>{req.status === 'approved' ? 'Entregue/Disp.' : 'Em Falta'}</span>
                    {req.status === 'out_of_stock' && !req.stockRestored && <button onClick={() => onMarkRestocked(req.id)} className="flex items-center gap-1 bg-blue-50 text-blue-600 border border-blue-200 px-2 py-1 rounded text-xs hover:bg-blue-100 transition"><Icons.RefreshCw /> Reposto?</button>}
                    {req.status === 'out_of_stock' && req.stockRestored && <span className="text-xs text-blue-600 font-bold border border-blue-100 bg-blue-50 px-2 py-1 rounded">Estoque OK</span>}
                </div>
            </div>
        );

        const MovementsView = ({ userRole }) => {
            const [movements, setMovements] = React.useState([]);
            const [loading, setLoading] = React.useState(true);

            React.useEffect(() => {
                // Busca movimenta√ß√µes
                const q = query(collection(db, 'movimentacoes_estoque_2026'), orderBy('timestamp', 'desc'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setMovements(snapshot.docs.map(d => ({id: d.id, ...d.data()})));
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            if (loading) return <div className="text-center py-10 text-slate-500">Carregando hist√≥rico...</div>;

            return (
                <div className="animate-in fade-in space-y-4">
                    <h3 className="text-lg font-bold text-slate-700 flex items-center gap-2 mb-4"><Icons.Activity /> Hist√≥rico de Movimenta√ß√µes</h3>
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-slate-50 text-slate-500 font-semibold border-b">
                                <tr>
                                    <th className="p-3">Data</th>
                                    <th className="p-3">Item</th>
                                    <th className="p-3">Qtd</th>
                                    <th className="p-3">Tipo</th>
                                    <th className="p-3">Origem</th>
                                    <th className="p-3">Usu√°rio</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {movements.map(mov => (
                                    <tr key={mov.id} className="hover:bg-slate-50">
                                        <td className="p-3 text-slate-500 text-xs">{formatDate(mov.timestamp)}</td>
                                        <td className="p-3 font-medium text-slate-700">{mov.itemName}</td>
                                        <td className="p-3 font-bold">{mov.quantity}</td>
                                        <td className="p-3">
                                            {mov.type === 'in' ? 
                                                <span className="bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs font-bold flex items-center w-fit gap-1"><Icons.ArrowUpCircle/> Entrada</span> : 
                                                <span className="bg-red-100 text-red-700 px-2 py-0.5 rounded text-xs font-bold flex items-center w-fit gap-1"><Icons.ArrowDownCircle/> Sa√≠da</span>
                                            }
                                        </td>
                                        <td className="p-3 text-xs uppercase tracking-wide text-slate-500">{mov.origin}</td>
                                        <td className="p-3 text-xs text-slate-600">{mov.user}</td>
                                    </tr>
                                ))}
                                {movements.length === 0 && <tr><td colSpan="6" className="p-8 text-center text-slate-400">Nenhuma movimenta√ß√£o registrada.</td></tr>}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const InventoryView = ({ userRole, currentUser }) => {
            const [items, setItems] = React.useState([]);
            const [searchTerm, setSearchTerm] = React.useState('');
            const [showForm, setShowForm] = React.useState(false);
            const [isInventoryLocked, setIsInventoryLocked] = React.useState(true);
            const [newItem, setNewItem] = React.useState({ name: '', category: 'epi', unit: 'un', currentQty: 0, minQty: 0, maxQty: 0, location: '', notes: '' });

            React.useEffect(() => {
                const q = query(collection(db, 'estoque_lab_2026'), orderBy('name'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setItems(docs);
                });
                return () => unsubscribe();
            }, []);

            const handleAddItem = async (e) => {
                e.preventDefault(); if (!newItem.name) return;
                try { await addDoc(collection(db, 'estoque_lab_2026'), { ...newItem, updatedAt: new Date().toISOString() }); setNewItem({ name: '', category: 'epi', unit: 'un', currentQty: 0, minQty: 0, maxQty: 0, location: '', notes: '' }); setShowForm(false); } catch (e) { console.error(e); }
            };

            const handleUpdateQty = async (id, itemName, currentQty, change) => {
                const newQty = parseInt(currentQty) + change;
                if (newQty < 0) return;
                try {
                    await processStockTransaction(itemName, Math.abs(change), change > 0 ? 'in' : 'out', 'manual', currentUser, null, 'Ajuste Manual R√°pido');
                } catch (e) { alert(e.message); }
            };
            
            const handleDeleteItem = async (id) => {
                if (confirm('Tem certeza que deseja excluir este item do estoque?')) {
                    try { await deleteDoc(doc(db, 'estoque_lab_2026', id)); } catch(e) { console.error(e); }
                }
            };

            const handleEditItem = async (id, updatedData) => {
                try {
                    await updateDoc(doc(db, 'estoque_lab_2026', id), { ...updatedData, updatedAt: new Date().toISOString() });
                } catch (e) { console.error(e); }
            };

            const filteredItems = items.filter(item => item.name.toLowerCase().includes(searchTerm.toLowerCase()));

            return (
                <div className="animate-in fade-in">
                    <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <div className="relative w-full md:w-96">
                            <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Search /></div>
                            <input type="text" placeholder="Buscar item no estoque..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-10 pr-4 py-2 rounded-full border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none shadow-sm" />
                        </div>
                        
                        <div className="flex gap-2">
                             <button 
                                onClick={() => setIsInventoryLocked(!isInventoryLocked)} 
                                className={`px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2 transition ${isInventoryLocked ? 'bg-slate-100 text-slate-600 hover:bg-slate-200' : 'bg-red-100 text-red-600 hover:bg-red-200'}`}
                                title={isInventoryLocked ? "Destravar Edi√ß√£o" : "Travar Edi√ß√£o"}
                            >
                                {isInventoryLocked ? <><Icons.Lock /> Travado</> : <><Icons.Unlock /> Destravado</>}
                            </button>
                            <button onClick={() => setShowForm(!showForm)} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold shadow flex items-center gap-2">
                                <Icons.Plus /> Novo Item
                            </button>
                        </div>
                    </div>

                    {showForm && (
                        <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200 mb-6">
                            <h3 className="font-bold text-slate-700 mb-3">Cadastrar Novo Item</h3>
                            <form onSubmit={handleAddItem} className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <input className="p-2 border rounded" placeholder="Nome do Item" value={newItem.name} onChange={e => setNewItem({...newItem, name: e.target.value})} required />
                                <select className="p-2 border rounded" value={newItem.category} onChange={e => setNewItem({...newItem, category: e.target.value})}>
                                    {/* SE FOR ADMIN, S√ì MOSTRA CATEGORIAS DE ADM. SE MASTER, MOSTRA TUDO */}
                                    {userRole === 'master' && <optgroup label="Log√≠stica (Opcional)"><option value="reagente">Reagente</option><option value="materiais">Materiais</option><option value="consumivel_log">Consum√≠vel Lab</option></optgroup>}
                                    <optgroup label="Administra√ß√£o"><option value="epi">EPI</option><option value="escritorio">Escrit√≥rio</option><option value="consumivel_adm">Consum√≠vel Adm</option></optgroup>
                                </select>
                                <input className="p-2 border rounded" placeholder="Local (ex: A1)" value={newItem.location} onChange={e => setNewItem({...newItem, location: e.target.value})} />
                                <select className="p-2 border rounded" value={newItem.unit} onChange={e => setNewItem({...newItem, unit: e.target.value})}><option value="un">un</option><option value="cx">cx</option><option value="L">L</option><option value="kg">kg</option><option value="pct">pct</option></select>
                                <div className="md:col-span-4 grid grid-cols-3 gap-4">
                                    <input type="number" className="p-2 border rounded" placeholder="Qtd Atual" value={newItem.currentQty} onChange={e => setNewItem({...newItem, currentQty: e.target.value})} />
                                    <input type="number" className="p-2 border rounded" placeholder="Estoque M√≠nimo" value={newItem.minQty} onChange={e => setNewItem({...newItem, minQty: e.target.value})} />
                                    <input type="number" className="p-2 border rounded" placeholder="Estoque M√°ximo" value={newItem.maxQty} onChange={e => setNewItem({...newItem, maxQty: e.target.value})} />
                                </div>
                                <button type="submit" className="md:col-span-4 bg-green-600 text-white py-2 rounded font-bold hover:bg-green-700">Salvar Item</button>
                            </form>
                        </div>
                    )}
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {filteredItems.map(item => (
                            <InventoryItemCard 
                                key={item.id} 
                                item={item} 
                                isLocked={isInventoryLocked}
                                onUpdateQty={handleUpdateQty}
                                onDelete={handleDeleteItem}
                                onEdit={handleEditItem}
                            />
                        ))}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = React.useState(null);
            const [appUser, setAppUser] = React.useState(null);
            const [requests, setRequests] = React.useState([]);
            const [notices, setNotices] = React.useState({ logistics: '', admin: '' });
            const [loading, setLoading] = React.useState(true);
            const [view, setView] = React.useState('active'); 
            const [inventoryNames, setInventoryNames] = React.useState([]);
            const [newItem, setNewItem] = React.useState('');
            const [quantity, setQuantity] = React.useState('');
            const [unit, setUnit] = React.useState('un');
            const [category, setCategory] = React.useState('reagente');
            const [isUrgent, setIsUrgent] = React.useState(false);
            const [notes, setNotes] = React.useState('');
            const [searchTerm, setSearchTerm] = React.useState('');
            const [draftSaved, setDraftSaved] = React.useState(false);
            const [modalOpen, setModalOpen] = React.useState(false);
            const [selectedReqId, setSelectedReqId] = React.useState(null);
            const [stockMessage, setStockMessage] = React.useState('');

            React.useEffect(() => { signInAnonymously(auth).catch(console.error); onAuthStateChanged(auth, u => { setUser(u); const s = localStorage.getItem('labflow_user_v2'); if (s) setAppUser(JSON.parse(s)); setLoading(false); }); }, []);
            React.useEffect(() => { if (!user) return; onSnapshot(doc(db, 'solicitacoes_lab_2026', 'NOTICES_CONFIG'), s => s.exists() ? setNotices(s.data()) : setDoc(doc(db, 'solicitacoes_lab_2026', 'NOTICES_CONFIG'), { logistics: '', admin: '' })); }, [user]);
            React.useEffect(() => { if (appUser && (newItem || quantity || notes)) { localStorage.setItem('labflow_draft_v1', JSON.stringify({ item: newItem, quantity, unit, category, notes, isUrgent })); setDraftSaved(true); setTimeout(() => setDraftSaved(false), 2000); } }, [newItem, quantity, unit, category, notes, isUrgent, appUser]);
            React.useEffect(() => { if (!user) return; onSnapshot(query(collection(db, 'solicitacoes_lab_2026'), orderBy('createdAt', 'desc')), s => setRequests(s.docs.filter(d => d.id !== 'NOTICES_CONFIG').map(d => ({ id: d.id, ...d.data() })))); }, [user]);
            React.useEffect(() => { if (!user) return; const q = query(collection(db, 'estoque_lab_2026'), orderBy('name')); const unsub = onSnapshot(q, (s) => setInventoryNames(s.docs.map(d => d.data().name))); return () => unsub(); }, [user]);

            const handleLogin = (u) => { setAppUser(u); localStorage.setItem('labflow_user_v2', JSON.stringify(u)); };
            const handleLogout = () => { setAppUser(null); localStorage.removeItem('labflow_user_v2'); };
            const handleUpdateNotice = async (n) => await updateDoc(doc(db, 'solicitacoes_lab_2026', 'NOTICES_CONFIG'), n);
            const handleSubmitRequest = async (e) => { e.preventDefault(); if (!newItem.trim() || !quantity) return; await addDoc(collection(db, 'solicitacoes_lab_2026'), { item: newItem, quantity, unit, category, isUrgent, notes, requesterName: appUser.name, requesterSector: appUser.sector, requesterId: user.uid, createdAt: new Date().toISOString(), status: 'pending', statusUpdatedAt: new Date().toISOString() }); setNewItem(''); setQuantity(''); setNotes(''); localStorage.removeItem('labflow_draft_v1'); alert('Solicita√ß√£o enviada!'); };
            const handleSaveStockInfo = async (id, c, l, n) => { await updateDoc(doc(db, 'solicitacoes_lab_2026', id), { itemCode: c, storageLocation: l }); const cat = JSON.parse(localStorage.getItem('labflow_catalog') || '{}'); cat[n.trim().toLowerCase()] = { code: c, loc: l }; localStorage.setItem('labflow_catalog', JSON.stringify(cat)); };
            const handleUpdateReq = async (id, d) => await updateDoc(doc(db, 'solicitacoes_lab_2026', id), d);
            const handleApprovePartial = async (id, nq, oq) => { await updateDoc(doc(db, 'solicitacoes_lab_2026', id), { status: 'approved', quantity: nq, statusUpdatedAt: new Date().toISOString(), logisticsMessage: `Qtd Ajustada. Solicitado: ${oq}` }); };
            const handleMarkRestocked = async (id) => await updateDoc(doc(db, 'solicitacoes_lab_2026', id), { stockRestored: true });
            const handleOutOfStockClick = (id) => { setSelectedReqId(id); setStockMessage(''); setModalOpen(true); };
            const confirmOutOfStock = async () => { if (!selectedReqId) return; await updateDoc(doc(db, 'solicitacoes_lab_2026', selectedReqId), { status: 'out_of_stock', statusUpdatedAt: new Date().toISOString(), logisticsMessage: stockMessage || '' }); setModalOpen(false); };
            const updateStatus = async (id, s) => { const d = { status: s, statusUpdatedAt: new Date().toISOString() }; if (s === 'approved' || s === 'pending') d.logisticsMessage = ''; await updateDoc(doc(db, 'solicitacoes_lab_2026', id), d); };
            const deleteRequest = async (id) => { if (confirm('Excluir?')) await deleteDoc(doc(db, 'solicitacoes_lab_2026', id)); };
            const handleExportPDF = () => {
                const d7 = new Date(); d7.setDate(d7.getDate() - 7);
                let data = requests.filter(r => new Date(r.createdAt) > d7);
                if (appUser.role === 'lab_tech') data = data.filter(r => r.requesterSector === appUser.sector);
                else if (appUser.role === 'logistics') data = data.filter(r => CAT_GROUPS.logistics.includes(r.category));
                else if (appUser.role === 'admin') data = data.filter(r => CAT_GROUPS.admin.includes(r.category));
                if (!data.length) return alert("Nada para exportar.");
                
                // ORDENA√á√ÉO POR SETOR
                const priorityOrder = ['QGI', 'MIC', 'ESP', 'FQA'];
                data.sort((a, b) => {
                    const sectorA = a.requesterSector || 'OUTROS';
                    const sectorB = b.requesterSector || 'OUTROS';
                    const idxA = priorityOrder.indexOf(sectorA);
                    const idxB = priorityOrder.indexOf(sectorB);
                    if (idxA !== -1 && idxB !== -1) return idxA - idxB;
                    if (idxA !== -1) return -1;
                    if (idxB !== -1) return 1;
                    return sectorA.localeCompare(sectorB);
                });

                const { jsPDF } = window.jspdf; const doc = new jsPDF('l', 'mm', 'a4');
                doc.setFontSize(18); doc.text("Relat√≥rio Semanal - LabFlow 2026", 14, 22);
                doc.setFontSize(10); doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, 14, 28);
                doc.text(`Perfil: ${appUser.role === 'logistics' ? 'Log√≠stica' : appUser.role === 'admin' ? 'Administra√ß√£o' : appUser.role === 'master' ? 'Gestor do Sistema' : appUser.sector}`, 14, 33);
                doc.autoTable({ 
                    head: [["Data", "C√≥d", "Item", "Local", "Qtd", "Cat", "Solicitante", "Status"]], 
                    body: data.map(r => {
                        const rawLabel = CAT_LABELS[r.category] || r.category;
                        const cleanLabel = CAT_LABELS_CLEAN[r.category] || r.category;
                        let statusPT = 'Pendente';
                        if (r.status === 'approved') statusPT = 'Dispon√≠vel';
                        if (r.status === 'out_of_stock') statusPT = 'Em Falta';
                        return [new Date(r.createdAt).toLocaleDateString('pt-BR'), r.itemCode||'-', r.item, r.storageLocation||'-', `${r.quantity} ${r.unit}`, cleanLabel, `${r.requesterName} (${r.requesterSector})`, statusPT];
                    }), 
                    startY: 40 
                });
                doc.save('relatorio.pdf');
            };
            
            const handleArchiveCycle = async () => {
                if (!confirm("Isso mover√° todos os itens 'Dispon√≠vel' ou 'Em Falta' da Administra√ß√£o para o hist√≥rico. Confirmar?")) return;
                const itemsToArchive = requests.filter(r => (r.status === 'approved' || r.status === 'out_of_stock') && !r.isArchived && CAT_GROUPS.admin.includes(r.category));
                if (itemsToArchive.length === 0) return alert("Nenhum item pronto para arquivar.");
                const batch = writeBatch(db);
                itemsToArchive.forEach(req => { const ref = doc(db, 'solicitacoes_lab_2026', req.id); batch.update(ref, { isArchived: true }); });
                try { await batch.commit(); alert(`${itemsToArchive.length} itens movidos para o hist√≥rico.`); } catch(e) { console.error(e); alert("Erro ao arquivar."); }
            };

            const { activeList, historyList } = React.useMemo(() => {
                if (!appUser) return { activeList: [], historyList: [] };
                let list = requests.filter(r => r.item.toLowerCase().includes(searchTerm.toLowerCase()) || r.requesterName.toLowerCase().includes(searchTerm.toLowerCase()));
                if (appUser.role === 'logistics') list = list.filter(r => CAT_GROUPS.logistics.includes(r.category));
                if (appUser.role === 'admin') list = list.filter(r => CAT_GROUPS.admin.includes(r.category));
                const active = [], history = [];
                list.forEach(r => {
                    if (r.isArchived) { history.push(r); } else {
                        const finished = r.status === 'approved' || r.status === 'out_of_stock';
                        if (CAT_GROUPS.admin.includes(r.category)) { active.push(r); } else {
                            const recent = isRecent(r.statusUpdatedAt || r.createdAt, 7);
                            if (r.status === 'pending' || (finished && recent)) active.push(r); else history.push(r);
                        }
                    }
                });
                return { activeList: active, historyList: history };
            }, [requests, searchTerm, appUser]);

            const missingHistory = historyList.filter(r => r.status === 'out_of_stock');
            const deliveredHistory = historyList.filter(r => r.status === 'approved');
            const isCarnival = isCarnivalSeason();

            if (loading) return <div className="flex h-screen items-center justify-center text-slate-500">Conectando...</div>;
            if (!appUser) return <LoginScreen onLogin={handleLogin} />;

            return (
                <div className={`min-h-screen pb-20 fade-in ${isCarnival ? 'theme-carnaval' : ''}`}>
                    <NoticeBanner notices={notices} userRole={appUser.role} onUpdateNotice={handleUpdateNotice} />
                    <header className={`bg-white text-slate-800 shadow-sm border-b border-slate-200 sticky top-0 z-10 ${isCarnival ? 'header-bg' : ''}`}>
                        <div className="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center"><div className="flex items-center gap-4 select-none"><InstitutionalLogo />{isCarnival && <span className="bg-pink-100 text-pink-700 text-[10px] font-bold px-2 py-0.5 rounded-full border border-pink-200 animate-pulse">üé≠ CARNAVAL</span>}<div className="hidden sm:block h-8 w-px bg-slate-200"></div><div><h1 className="text-sm font-bold text-slate-700 leading-tight">LABFLOW</h1><p className="text-xs text-slate-500 uppercase">{appUser.role === 'master' ? 'Gestor do Sistema' : appUser.role === 'admin' ? 'Administra√ß√£o' : appUser.role === 'logistics' ? 'Log√≠stica' : appUser.sector}</p></div></div><div className="flex items-center gap-2"><button onClick={handleExportPDF} className="flex items-center gap-2 bg-red-50 hover:bg-red-100 text-red-700 border border-red-200 text-xs font-bold py-2 px-3 rounded transition"><Icons.FileText /><span className="hidden sm:inline">PDF</span></button><button onClick={handleLogout} className="text-slate-400 hover:text-red-500 p-2 transition"><Icons.LogOut /></button></div></div>
                        <div className={`bg-blue-600 px-4 py-2 text-center text-xs sm:text-sm font-medium text-white shadow-inner flex justify-center gap-6 ${isCarnival ? 'bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600' : ''}`}><span>üß™ Lab: <span className="text-yellow-300 font-bold">{getNextMonday()}</span></span><span>üìé Escrit√≥rio: <span className="text-yellow-300 font-bold">{getNextOfficeDay()}</span></span></div>
                    </header>
                    <main className="max-w-5xl mx-auto px-4 py-6">
                        <div className="flex gap-4 mb-6 border-b border-slate-200 overflow-x-auto"><button onClick={() => setView('active')} className={`pb-2 px-1 text-sm font-bold border-b-2 transition whitespace-nowrap ${view === 'active' ? (isCarnival ? 'border-pink-500 text-pink-600' : 'border-blue-600 text-blue-600') : 'border-transparent text-slate-500'}`}>Pedidos em Aberto</button><button onClick={() => setView('history')} className={`pb-2 px-1 text-sm font-bold border-b-2 transition whitespace-nowrap flex items-center gap-2 ${view === 'history' ? (isCarnival ? 'border-pink-500 text-pink-600' : 'border-blue-600 text-blue-600') : 'border-transparent text-slate-500'}`}><Icons.History /> Hist√≥rico</button>{(appUser.role === 'admin' || appUser.role === 'master') && <button onClick={() => setView('inventory')} className={`pb-2 px-1 text-sm font-bold border-b-2 transition whitespace-nowrap flex items-center gap-2 ${view === 'inventory' ? (isCarnival ? 'border-pink-500 text-pink-600' : 'border-blue-600 text-blue-600') : 'border-transparent text-slate-500'}`}><Icons.Box /> Controle de Estoque</button>}{(appUser.role === 'admin' || appUser.role === 'master') && <button onClick={() => setView('movements')} className={`pb-2 px-1 text-sm font-bold border-b-2 transition whitespace-nowrap flex items-center gap-2 ${view === 'movements' ? (isCarnival ? 'border-pink-500 text-pink-600' : 'border-blue-600 text-blue-600') : 'border-transparent text-slate-500'}`}><Icons.Activity /> Movimenta√ß√µes</button>}</div>
                        {view === 'active' && (
                            <>
                                {appUser.role === 'lab_tech' && (
                                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-5 mb-8 relative">
                                        {draftSaved && <div className="absolute top-0 right-0 bg-green-100 text-green-700 text-[10px] px-2 py-1 rounded-bl-lg flex items-center gap-1"><Icons.Save /> Salvo</div>}
                                        <h2 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2"><div className={`${isCarnival ? 'text-pink-600' : 'text-blue-600'}`}><Icons.ClipboardList /></div> Nova Solicita√ß√£o</h2>
                                        <form onSubmit={handleSubmitRequest} className="space-y-4">
                                            <div className="grid grid-cols-1 md:grid-cols-12 gap-4">
                                                <div className="md:col-span-5"><label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Item</label><input type="text" value={newItem} onChange={(e) => setNewItem(e.target.value)} placeholder="Ex: Item..." list="inventory-list" className="w-full p-2.5 bg-slate-50 border border-slate-300 rounded-lg outline-none" /><datalist id="inventory-list">{inventoryNames.map((name, i) => <option key={i} value={name} />)}</datalist></div>
                                                <div className="md:col-span-2"><label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Qtd</label><input type="number" value={quantity} onChange={(e) => setQuantity(e.target.value)} className="w-full p-2.5 bg-slate-50 border border-slate-300 rounded-lg outline-none" /></div>
                                                <div className="md:col-span-2"><label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Unid</label><select value={unit} onChange={(e) => setUnit(e.target.value)} className="w-full p-2.5 bg-slate-50 border border-slate-300 rounded-lg outline-none"><option value="un">Unid.</option><option value="cx">Caixa</option><option value="ml">ml</option><option value="L">L</option><option value="pct">Pacote</option></select></div>
                                                <div className="md:col-span-3"><label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Categoria</label><select value={category} onChange={(e) => setCategory(e.target.value)} className="w-full p-2.5 bg-slate-50 border border-slate-300 rounded-lg outline-none"><optgroup label="Log√≠stica"><option value="reagente">üß™ Reagente</option><option value="materiais">üì¶ Materiais</option><option value="consumivel_log">üß¥ Consum√≠vel (Lab)</option></optgroup><optgroup label="Adm"><option value="epi">ü•Ω EPI</option><option value="escritorio">üìé Escrit√≥rio</option><option value="consumivel_adm">üóëÔ∏è Consum√≠vel (Adm)</option></optgroup></select></div>
                                            </div>
                                            <div className="flex flex-col md:flex-row gap-4 items-center"><input type="text" value={notes} onChange={(e) => setNotes(e.target.value)} placeholder="Observa√ß√µes..." className="flex-1 w-full p-2.5 bg-slate-50 border border-slate-300 rounded-lg text-sm outline-none" /><div className="flex items-center gap-3 w-full md:w-auto"><label className="flex items-center gap-2 cursor-pointer bg-red-50 text-red-700 px-3 py-2.5 rounded-lg border border-red-100 hover:bg-red-100 transition whitespace-nowrap"><input type="checkbox" checked={isUrgent} onChange={(e) => setIsUrgent(e.target.checked)} className="w-4 h-4 text-red-600 rounded" /><span className="font-semibold text-sm">Urgente</span></label><button type="submit" className={`flex-1 text-white px-6 py-2.5 rounded-lg font-bold shadow-md transition whitespace-nowrap ${isCarnival ? 'btn-primary' : 'bg-blue-600 hover:bg-blue-700'}`}>Adicionar</button></div></div>
                                        </form>
                                    </div>
                                )}
                                <div className="flex flex-col md:flex-row justify-between items-end md:items-center gap-4 mb-6"><div className="relative w-full md:w-96"><div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Search /></div><input type="text" placeholder="Buscar..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-10 pr-4 py-2 rounded-full border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none shadow-sm" /></div><div className="flex items-center gap-4"><div className="text-sm font-medium text-slate-600 bg-slate-200 px-3 py-1 rounded-full">Exibindo: {activeList.length}</div>{(appUser.role === 'admin' || appUser.role === 'master') && <button onClick={handleArchiveCycle} className="bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold py-2 px-3 rounded shadow flex items-center gap-2 animate-in fade-in"><Icons.Archive /> Fechar Ciclo</button>}</div></div>
                                <div className="space-y-3">{activeList.length === 0 ? <div className="text-center text-slate-400 py-10">Nenhum pedido pendente ou recente.</div> : activeList.map((req) => (<RequestCard key={req.id} req={req} role={appUser.role} onDelete={deleteRequest} onUpdateStatus={updateStatus} onOutOfStock={handleOutOfStockClick} onSaveStockInfo={handleSaveStockInfo} onApprovePartial={handleApprovePartial} onUpdateReq={handleUpdateReq} currentUser={appUser} />))}</div>
                            </>
                        )}
                        {view === 'history' && (
                            <div className="space-y-8 animate-in fade-in">
                                <div className="relative w-full md:w-96 mb-4"><div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Search /></div><input type="text" placeholder="Buscar no hist√≥rico..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full pl-10 pr-4 py-2 rounded-full border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none shadow-sm" /></div>
                                <div><h3 className="text-lg font-bold text-red-700 mb-3 flex items-center gap-2"><Icons.PackageX /> Itens em Falta (Hist√≥rico)</h3><div className="space-y-3">{missingHistory.map(req => (<HistoryRow key={req.id} req={req} onMarkRestocked={handleMarkRestocked} />))}</div></div>
                                <div><h3 className="text-lg font-bold text-green-700 mb-3 flex items-center gap-2"><Icons.CheckCircle2 /> Itens Entregues/Dispon√≠veis (Hist√≥rico)</h3><div className="space-y-3">{deliveredHistory.map(req => (<HistoryRow key={req.id} req={req} onMarkRestocked={handleMarkRestocked} />))}</div></div>
                            </div>
                        )}
                        {view === 'inventory' && <InventoryView userRole={appUser.role} currentUser={appUser} />}
                        {view === 'movements' && <MovementsView userRole={appUser.role} />}
                    </main>
                    {modalOpen && (<div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay fade-in"><div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm"><h3 className="text-lg font-bold text-red-600 flex items-center gap-2 mb-4"><Icons.PackageX /> Item Indispon√≠vel</h3><p className="text-sm text-slate-600 mb-2">Informe o motivo ou previs√£o:</p><textarea value={stockMessage} onChange={(e) => setStockMessage(e.target.value)} placeholder="Ex: Em processo de compra..." className="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500 outline-none h-24 text-sm mb-4"></textarea><div className="flex gap-2"><button onClick={() => setModalOpen(false)} className="flex-1 py-2 border border-slate-300 rounded-lg text-slate-600 font-semibold hover:bg-slate-50">Cancelar</button><button onClick={confirmOutOfStock} className="flex-1 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 shadow">Confirmar</button></div></div></div>)}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>